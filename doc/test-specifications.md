# 営業日報システム テスト仕様書

## 目次

1. [テスト計画](#テスト計画)
2. [テスト環境](#テスト環境)
3. [単体テスト](#単体テスト)
4. [結合テスト（APIテスト）](#結合テストapiテスト)
5. [E2Eテスト（画面テスト）](#e2eテスト画面テスト)
6. [非機能テスト](#非機能テスト)
7. [テストデータ](#テストデータ)

---

## テスト計画

### テスト目的

営業日報システムが要件定義通りに動作し、品質基準を満たしていることを確認する。

### テスト範囲

- 認証機能
- 日報管理機能（作成・編集・削除・提出・承認）
- 訪問記録管理機能
- コメント機能
- 顧客マスタ管理機能
- 営業マスタ管理機能
- 権限制御
- バリデーション
- エラーハンドリング

### テスト種類

| テスト種類   | 目的                             | 実施タイミング     |
| ------------ | -------------------------------- | ------------------ |
| 単体テスト   | 個々の関数・メソッドの動作確認   | 開発中・コミット前 |
| 結合テスト   | APIエンドポイントの動作確認      | 機能実装完了後     |
| E2Eテスト    | ユーザー視点での画面操作確認     | 全機能実装完了後   |
| 非機能テスト | パフォーマンス・セキュリティ確認 | リリース前         |

### 合格基準

- 単体テスト: カバレッジ80%以上、すべてのテストケースがPass
- 結合テスト: すべてのAPIエンドポイントが正常動作
- E2Eテスト: すべての主要ユーザーフローが正常動作
- 重大な不具合（Severity: Critical/High）がゼロ

### テストツール

- 単体テスト: Jest / Vitest
- 結合テスト: Supertest / Postman
- E2Eテスト: Playwright / Cypress
- パフォーマンステスト: k6 / Artillery
- セキュリティテスト: OWASP ZAP

---

## テスト環境

### 環境構成

| 環境         | 用途                     | URL                                      |
| ------------ | ------------------------ | ---------------------------------------- |
| ローカル     | 開発者の手元での動作確認 | http://localhost:3000                    |
| テスト       | 自動テストの実行環境     | https://test.sales-report.example.com    |
| ステージング | 本番前の最終確認         | https://staging.sales-report.example.com |
| 本番         | 実運用環境               | https://sales-report.example.com         |

### テストデータ

- テスト用DBを使用（本番データは使用しない）
- テストデータは各テスト実行前に初期化
- マスタデータ（営業、顧客）はシードデータとして事前投入

---

## 単体テスト

### 1. 認証機能のテスト

#### UT-AUTH-001: パスワードのハッシュ化

| 項目         | 内容                                                                                                                   |
| ------------ | ---------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | パスワードハッシュ化関数のテスト                                                                                       |
| 目的         | パスワードが正しくハッシュ化されることを確認                                                                           |
| 前提条件     | なし                                                                                                                   |
| テストデータ | 平文パスワード: "password123"                                                                                          |
| 期待結果     | ハッシュ化されたパスワードが返される<br>同じパスワードでも毎回異なるハッシュが生成される<br>bcrypt.compare()で検証可能 |

#### UT-AUTH-002: JWTトークン生成

| 項目         | 内容                                                                                                |
| ------------ | --------------------------------------------------------------------------------------------------- |
| テスト項目   | JWTトークン生成関数のテスト                                                                         |
| 目的         | 正しい形式のJWTトークンが生成されることを確認                                                       |
| 前提条件     | なし                                                                                                |
| テストデータ | ユーザーID: 1, メール: "test@example.com"                                                           |
| 期待結果     | 有効なJWTトークンが返される<br>デコード時にペイロードが正しく取得できる<br>有効期限が設定されている |

#### UT-AUTH-003: JWTトークン検証

| 項目         | 内容                                                                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |
| テスト項目   | JWTトークン検証関数のテスト                                                                                                                |
| 目的         | トークンの検証が正しく動作することを確認                                                                                                   |
| 前提条件     | 有効なトークンと無効なトークンを用意                                                                                                       |
| テストケース | 1. 有効なトークン → 検証成功<br>2. 期限切れトークン → 検証失敗<br>3. 署名が不正なトークン → 検証失敗<br>4. 不正な形式のトークン → 検証失敗 |
| 期待結果     | 各ケースで適切な結果が返される                                                                                                             |

---

### 2. 日報機能のテスト

#### UT-REPORT-001: 日報作成バリデーション

| 項目         | 内容                                                                                                                                                                                                                              |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 日報作成時のバリデーション                                                                                                                                                                                                        |
| 目的         | 入力値の検証が正しく動作することを確認                                                                                                                                                                                            |
| テストケース | 1. 正常な入力値 → バリデーション成功<br>2. report_dateが未来の日付 → エラー<br>3. report_dateが不正な形式 → エラー<br>4. problemが1000文字超過 → エラー<br>5. planが1000文字超過 → エラー<br>6. 同一日付の日報が既に存在 → エラー |
| 期待結果     | 各ケースで適切なバリデーション結果が返される                                                                                                                                                                                      |

#### UT-REPORT-002: 日報ステータス遷移チェック

| 項目         | 内容                                                                                                                                                                      |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 日報ステータスの遷移ロジック                                                                                                                                              |
| 目的         | ステータス遷移が正しく制御されることを確認                                                                                                                                |
| テストケース | 1. draft → submitted: 許可<br>2. submitted → approved: 許可（上長のみ）<br>3. submitted → draft: 不許可<br>4. approved → submitted: 不許可<br>5. approved → draft: 不許可 |
| 期待結果     | 許可されない遷移は例外が発生                                                                                                                                              |

#### UT-REPORT-003: 日報編集権限チェック

| 項目         | 内容                                                                                                                                                                                         |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 日報編集権限の判定ロジック                                                                                                                                                                   |
| 目的         | 編集権限が正しく判定されることを確認                                                                                                                                                         |
| テストケース | 1. 自分の日報（draft） → 編集可能<br>2. 自分の日報（submitted） → 編集不可<br>3. 自分の日報（approved） → 編集不可<br>4. 他人の日報 → 編集不可<br>5. 上長が部下の日報 → 編集不可（閲覧のみ） |
| 期待結果     | 各ケースで適切な権限判定が行われる                                                                                                                                                           |

---

### 3. 訪問記録機能のテスト

#### UT-VISIT-001: 訪問記録バリデーション

| 項目         | 内容                                                                                                                                                                                                                                                                  |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 訪問記録作成時のバリデーション                                                                                                                                                                                                                                        |
| 目的         | 入力値の検証が正しく動作することを確認                                                                                                                                                                                                                                |
| テストケース | 1. 正常な入力値 → バリデーション成功<br>2. customer_idが空 → エラー<br>3. visit_timeが不正な形式 → エラー<br>4. visit_contentが空 → エラー<br>5. visit_contentが500文字超過 → エラー<br>6. visit_resultが500文字超過 → エラー<br>7. next_actionが200文字超過 → エラー |
| 期待結果     | 各ケースで適切なバリデーション結果が返される                                                                                                                                                                                                                          |

#### UT-VISIT-002: 訪問記録の表示順制御

| 項目         | 内容                                                                         |
| ------------ | ---------------------------------------------------------------------------- |
| テスト項目   | display_orderによるソート処理                                                |
| 目的         | 訪問記録が正しい順序で取得されることを確認                                   |
| 前提条件     | 複数の訪問記録が存在                                                         |
| テストケース | 1. display_order昇順でソート<br>2. 同じdisplay_orderの場合は作成日時でソート |
| 期待結果     | 正しい順序で訪問記録が返される                                               |

---

### 4. コメント機能のテスト

#### UT-COMMENT-001: コメント投稿権限チェック

| 項目         | 内容                                                                                                                                                                             |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | コメント投稿権限の判定ロジック                                                                                                                                                   |
| 目的         | 上長のみがコメントできることを確認                                                                                                                                               |
| テストケース | 1. 上長が部下の日報にコメント → 許可<br>2. 営業担当者が自分の日報にコメント → 不許可<br>3. 営業担当者が他人の日報にコメント → 不許可<br>4. 上長が他部署の日報にコメント → 不許可 |
| 期待結果     | 各ケースで適切な権限判定が行われる                                                                                                                                               |

#### UT-COMMENT-002: コメントタイプバリデーション

| 項目         | 内容                                                                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |
| テスト項目   | comment_typeの値チェック                                                                                                                   |
| 目的         | 正しいcomment_type以外は拒否されることを確認                                                                                               |
| テストケース | 1. comment_type: "problem" → 許可<br>2. comment_type: "plan" → 許可<br>3. comment_type: "invalid" → エラー<br>4. comment_typeが空 → エラー |
| 期待結果     | 不正な値はバリデーションエラー                                                                                                             |

---

### 5. 顧客マスタ機能のテスト

#### UT-CUSTOMER-001: 顧客情報バリデーション

| 項目         | 内容                                                                                                                                                                                                                                                          |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 顧客情報のバリデーション                                                                                                                                                                                                                                      |
| 目的         | 入力値の検証が正しく動作することを確認                                                                                                                                                                                                                        |
| テストケース | 1. 正常な入力値 → バリデーション成功<br>2. customer_nameが空 → エラー<br>3. customer_nameが50文字超過 → エラー<br>4. company_nameが空 → エラー<br>5. company_nameが100文字超過 → エラー<br>6. emailが不正な形式 → エラー<br>7. phoneに英字が含まれる → エラー |
| 期待結果     | 各ケースで適切なバリデーション結果が返される                                                                                                                                                                                                                  |

#### UT-CUSTOMER-002: 顧客削除制御

| 項目         | 内容                                                                                                                                    |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | 顧客削除（論理削除）の動作確認                                                                                                          |
| 目的         | 物理削除ではなく論理削除されることを確認                                                                                                |
| 前提条件     | 顧客データが存在                                                                                                                        |
| テストケース | 1. 削除実行 → is_activeがfalseになる<br>2. 削除後、一覧取得でデフォルト表示されない<br>3. 削除後、is_active=falseで検索すると取得できる |
| 期待結果     | データは物理削除されず、is_activeフラグで制御される                                                                                     |

---

### 6. 営業マスタ機能のテスト

#### UT-SALES-001: メールアドレス重複チェック

| 項目         | 内容                                                                     |
| ------------ | ------------------------------------------------------------------------ |
| テスト項目   | メールアドレスの一意性チェック                                           |
| 目的         | 既存のメールアドレスは登録できないことを確認                             |
| 前提条件     | "test@example.com" が既に登録されている                                  |
| テストケース | 1. 未使用のメールアドレス → 登録成功<br>2. 既存のメールアドレス → エラー |
| 期待結果     | 重複するメールアドレスは登録できない                                     |

#### UT-SALES-002: パスワード強度チェック

| 項目         | 内容                                                               |
| ------------ | ------------------------------------------------------------------ |
| テスト項目   | パスワードの強度バリデーション                                     |
| 目的         | 弱いパスワードは登録できないことを確認                             |
| テストケース | 1. 8文字以上 → 許可<br>2. 7文字以下 → エラー<br>3. 空文字 → エラー |
| 期待結果     | 8文字未満のパスワードは登録できない                                |

---

## 結合テスト（APIテスト）

### 1. 認証API

#### IT-AUTH-001: ログイン成功

| 項目       | 内容                                                                                                     |
| ---------- | -------------------------------------------------------------------------------------------------------- |
| テスト項目 | POST /auth/login - 正常系                                                                                |
| 前提条件   | 有効なユーザーが存在（email: test@example.com, password: password123）                                   |
| リクエスト | `json<br>{"email": "test@example.com", "password": "password123"}<br>`                                   |
| 期待結果   | ステータスコード: 200<br>レスポンスにaccess_token, refresh_tokenが含まれる<br>userオブジェクトが含まれる |

#### IT-AUTH-002: ログイン失敗（認証エラー）

| 項目         | 内容                                                                            |
| ------------ | ------------------------------------------------------------------------------- |
| テスト項目   | POST /auth/login - 異常系                                                       |
| 前提条件     | なし                                                                            |
| テストケース | 1. 存在しないメールアドレス<br>2. 間違ったパスワード<br>3. 無効化されたユーザー |
| 期待結果     | ステータスコード: 401<br>エラーコード: INVALID_CREDENTIALS                      |

#### IT-AUTH-003: トークン更新

| 項目       | 内容                                                  |
| ---------- | ----------------------------------------------------- |
| テスト項目 | POST /auth/refresh - 正常系                           |
| 前提条件   | 有効なrefresh_tokenを取得済み                         |
| リクエスト | `json<br>{"refresh_token": "有効なトークン"}<br>`     |
| 期待結果   | ステータスコード: 200<br>新しいaccess_tokenが返される |

#### IT-AUTH-004: 認証が必要なエンドポイントへのアクセス

| 項目         | 内容                                                                                                     |
| ------------ | -------------------------------------------------------------------------------------------------------- |
| テスト項目   | 認証チェックのテスト                                                                                     |
| テストケース | 1. トークンなし → 401<br>2. 無効なトークン → 401<br>3. 期限切れトークン → 401<br>4. 有効なトークン → 200 |
| 期待結果     | 適切な認証制御が行われる                                                                                 |

---

### 2. 日報API

#### IT-REPORT-001: 日報一覧取得

| 項目         | 内容                                                                                                                                                                        |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | GET /reports - 正常系                                                                                                                                                       |
| 前提条件     | 認証済み、日報データが存在                                                                                                                                                  |
| テストケース | 1. パラメータなし → 全日報取得（自分のみ）<br>2. start_date, end_date指定 → 期間絞り込み<br>3. status指定 → ステータス絞り込み<br>4. page, limit指定 → ページネーション動作 |
| 期待結果     | ステータスコード: 200<br>dataとpaginationが返される<br>他人の日報は含まれない（営業の場合）                                                                                 |

#### IT-REPORT-002: 日報一覧取得（上長）

| 項目         | 内容                                                                       |
| ------------ | -------------------------------------------------------------------------- |
| テスト項目   | GET /reports - 上長の場合                                                  |
| 前提条件     | 上長として認証済み                                                         |
| テストケース | 1. sales_id未指定 → 配下全員の日報<br>2. sales_id指定 → 指定した営業の日報 |
| 期待結果     | 配下の営業の日報が取得できる                                               |

#### IT-REPORT-003: 日報詳細取得

| 項目       | 内容                                                            |
| ---------- | --------------------------------------------------------------- |
| テスト項目 | GET /reports/:id - 正常系                                       |
| 前提条件   | 認証済み、日報データが存在                                      |
| 期待結果   | ステータスコード: 200<br>日報詳細、訪問記録、コメントが含まれる |

#### IT-REPORT-004: 日報詳細取得（権限エラー）

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | GET /reports/:id - 異常系                                |
| 前提条件   | 他人の日報が存在                                         |
| 期待結果   | ステータスコード: 403<br>エラーコード: PERMISSION_DENIED |

#### IT-REPORT-005: 日報作成

| 項目       | 内容                                                                                                     |
| ---------- | -------------------------------------------------------------------------------------------------------- |
| テスト項目 | POST /reports - 正常系                                                                                   |
| 前提条件   | 認証済み                                                                                                 |
| リクエスト | `json<br>{"report_date": "2026-01-05", "problem": "問題なし", "plan": "A社訪問", "status": "draft"}<br>` |
| 期待結果   | ステータスコード: 201<br>作成された日報が返される                                                        |

#### IT-REPORT-006: 日報作成（重複エラー）

| 項目       | 内容                                                         |
| ---------- | ------------------------------------------------------------ |
| テスト項目 | POST /reports - 異常系                                       |
| 前提条件   | 同一日付の日報が既に存在                                     |
| 期待結果   | ステータスコード: 409<br>エラーコード: REPORT_ALREADY_EXISTS |

#### IT-REPORT-007: 日報更新

| 項目       | 内容                                                              |
| ---------- | ----------------------------------------------------------------- |
| テスト項目 | PUT /reports/:id - 正常系                                         |
| 前提条件   | 下書き状態の日報が存在                                            |
| リクエスト | `json<br>{"problem": "更新後の問題", "plan": "更新後の予定"}<br>` |
| 期待結果   | ステータスコード: 200<br>更新された日報が返される                 |

#### IT-REPORT-008: 日報更新（提出済み）

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | PUT /reports/:id - 異常系                                |
| 前提条件   | 提出済みの日報が存在                                     |
| 期待結果   | ステータスコード: 403<br>エラーコード: PERMISSION_DENIED |

#### IT-REPORT-009: 日報削除

| 項目       | 内容                                      |
| ---------- | ----------------------------------------- |
| テスト項目 | DELETE /reports/:id - 正常系              |
| 前提条件   | 下書き状態の日報が存在                    |
| 期待結果   | ステータスコード: 204<br>日報が削除される |

#### IT-REPORT-010: 日報提出

| 項目       | 内容                                                                           |
| ---------- | ------------------------------------------------------------------------------ |
| テスト項目 | PATCH /reports/:id/submit - 正常系                                             |
| 前提条件   | 下書き状態の日報が存在、訪問記録が1件以上登録済み                              |
| 期待結果   | ステータスコード: 200<br>statusが"submitted"になる<br>submitted_atが設定される |

#### IT-REPORT-011: 日報提出（バリデーションエラー）

| 項目       | 内容                                                                                  |
| ---------- | ------------------------------------------------------------------------------------- |
| テスト項目 | PATCH /reports/:id/submit - 異常系                                                    |
| 前提条件   | 下書き状態の日報が存在、訪問記録が未登録                                              |
| 期待結果   | ステータスコード: 422<br>エラーコード: VALIDATION_ERROR<br>訪問記録が必要なメッセージ |

#### IT-REPORT-012: 日報承認

| 項目       | 内容                                                                         |
| ---------- | ---------------------------------------------------------------------------- |
| テスト項目 | PATCH /reports/:id/approve - 正常系                                          |
| 前提条件   | 上長として認証、配下の営業の提出済み日報が存在                               |
| 期待結果   | ステータスコード: 200<br>statusが"approved"になる<br>approved_atが設定される |

#### IT-REPORT-013: 日報承認（権限エラー）

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | PATCH /reports/:id/approve - 異常系                      |
| 前提条件   | 営業として認証                                           |
| 期待結果   | ステータスコード: 403<br>エラーコード: PERMISSION_DENIED |

---

### 3. 訪問記録API

#### IT-VISIT-001: 訪問記録作成

| 項目       | 内容                                                                                                                                       |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| テスト項目 | POST /reports/:report_id/visits - 正常系                                                                                                   |
| 前提条件   | 認証済み、自分の日報が存在                                                                                                                 |
| リクエスト | `json<br>{"customer_id": 10, "visit_time": "10:00", "visit_content": "商談実施", "visit_result": "好感触", "next_action": "見積提出"}<br>` |
| 期待結果   | ステータスコード: 201<br>作成された訪問記録が返される                                                                                      |

#### IT-VISIT-002: 訪問記録更新

| 項目       | 内容                                                  |
| ---------- | ----------------------------------------------------- |
| テスト項目 | PUT /visits/:id - 正常系                              |
| 前提条件   | 認証済み、自分の訪問記録が存在                        |
| 期待結果   | ステータスコード: 200<br>更新された訪問記録が返される |

#### IT-VISIT-003: 訪問記録削除

| 項目       | 内容                                          |
| ---------- | --------------------------------------------- |
| テスト項目 | DELETE /visits/:id - 正常系                   |
| 前提条件   | 認証済み、自分の訪問記録が存在                |
| 期待結果   | ステータスコード: 204<br>訪問記録が削除される |

---

### 4. コメントAPI

#### IT-COMMENT-001: コメント一覧取得

| 項目         | 内容                                                                                                                               |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | GET /reports/:report_id/comments - 正常系                                                                                          |
| 前提条件     | 認証済み、日報にコメントが存在                                                                                                     |
| テストケース | 1. comment_type未指定 → 全コメント<br>2. comment_type="problem" → Problemコメントのみ<br>3. comment_type="plan" → Planコメントのみ |
| 期待結果     | ステータスコード: 200<br>適切にフィルタリングされたコメント一覧が返される                                                          |

#### IT-COMMENT-002: コメント作成

| 項目       | 内容                                                                        |
| ---------- | --------------------------------------------------------------------------- |
| テスト項目 | POST /reports/:report_id/comments - 正常系                                  |
| 前提条件   | 上長として認証済み、配下の営業の日報が存在                                  |
| リクエスト | `json<br>{"comment_type": "problem", "comment_text": "アドバイスです"}<br>` |
| 期待結果   | ステータスコード: 201<br>作成されたコメントが返される                       |

#### IT-COMMENT-003: コメント作成（権限エラー）

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | POST /reports/:report_id/comments - 異常系               |
| 前提条件   | 営業として認証済み                                       |
| 期待結果   | ステータスコード: 403<br>エラーコード: PERMISSION_DENIED |

#### IT-COMMENT-004: コメント削除

| 項目       | 内容                                          |
| ---------- | --------------------------------------------- |
| テスト項目 | DELETE /comments/:id - 正常系                 |
| 前提条件   | 上長として認証済み、自分のコメントが存在      |
| 期待結果   | ステータスコード: 204<br>コメントが削除される |

---

### 5. 顧客マスタAPI

#### IT-CUSTOMER-001: 顧客一覧取得

| 項目         | 内容                                                                                                                                                 |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目   | GET /customers - 正常系                                                                                                                              |
| 前提条件     | 認証済み、顧客データが存在                                                                                                                           |
| テストケース | 1. パラメータなし → 自分の顧客のみ<br>2. customer_name指定 → 部分一致検索<br>3. industry指定 → 業種絞り込み<br>4. is_active=false → 無効な顧客も取得 |
| 期待結果     | ステータスコード: 200<br>適切にフィルタリングされた顧客一覧が返される                                                                                |

#### IT-CUSTOMER-002: 顧客作成

| 項目       | 内容                                                                                                  |
| ---------- | ----------------------------------------------------------------------------------------------------- |
| テスト項目 | POST /customers - 正常系                                                                              |
| 前提条件   | 認証済み                                                                                              |
| リクエスト | `json<br>{"customer_name": "山田一郎", "company_name": "ABC社", "industry": "IT", "sales_id": 1}<br>` |
| 期待結果   | ステータスコード: 201<br>作成された顧客が返される                                                     |

#### IT-CUSTOMER-003: 顧客更新

| 項目       | 内容                                              |
| ---------- | ------------------------------------------------- |
| テスト項目 | PUT /customers/:id - 正常系                       |
| 前提条件   | 認証済み、自分の顧客が存在                        |
| 期待結果   | ステータスコード: 200<br>更新された顧客が返される |

#### IT-CUSTOMER-004: 顧客削除

| 項目       | 内容                                                        |
| ---------- | ----------------------------------------------------------- |
| テスト項目 | DELETE /customers/:id - 正常系                              |
| 前提条件   | 認証済み、自分の顧客が存在                                  |
| 期待結果   | ステータスコード: 204<br>is_activeがfalseになる（論理削除） |

---

### 6. 営業マスタAPI

#### IT-SALES-001: 営業一覧取得

| 項目       | 内容                                              |
| ---------- | ------------------------------------------------- |
| テスト項目 | GET /sales - 正常系                               |
| 前提条件   | 上長として認証済み                                |
| 期待結果   | ステータスコード: 200<br>配下の営業一覧が返される |

#### IT-SALES-002: 営業一覧取得（権限エラー）

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | GET /sales - 異常系                                      |
| 前提条件   | 営業として認証済み                                       |
| 期待結果   | ステータスコード: 403<br>エラーコード: PERMISSION_DENIED |

#### IT-SALES-003: 営業作成

| 項目       | 内容                                                                                                                                                                    |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テスト項目 | POST /sales - 正常系                                                                                                                                                    |
| 前提条件   | 上長として認証済み                                                                                                                                                      |
| リクエスト | `json<br>{"sales_name": "山田太郎", "email": "yamada@example.com", "password": "password123", "department": "営業1部", "manager_id": 5, "hire_date": "2026-04-01"}<br>` |
| 期待結果   | ステータスコード: 201<br>作成された営業が返される                                                                                                                       |

#### IT-SALES-004: 営業作成（メール重複エラー）

| 項目       | 内容                                                        |
| ---------- | ----------------------------------------------------------- |
| テスト項目 | POST /sales - 異常系                                        |
| 前提条件   | 既存のメールアドレスを指定                                  |
| 期待結果   | ステータスコード: 409<br>エラーコード: EMAIL_ALREADY_EXISTS |

#### IT-SALES-005: 営業更新

| 項目       | 内容                                              |
| ---------- | ------------------------------------------------- |
| テスト項目 | PUT /sales/:id - 正常系                           |
| 前提条件   | 上長として認証済み                                |
| 期待結果   | ステータスコード: 200<br>更新された営業が返される |

#### IT-SALES-006: 営業削除

| 項目       | 内容                                                        |
| ---------- | ----------------------------------------------------------- |
| テスト項目 | DELETE /sales/:id - 正常系                                  |
| 前提条件   | 上長として認証済み                                          |
| 期待結果   | ステータスコード: 204<br>is_activeがfalseになる（論理削除） |

---

## E2Eテスト（画面テスト）

### 1. ログインフロー

#### E2E-LOGIN-001: ログインから日報作成まで

| 項目           | 内容                                                                                                                                                                                                                       |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | ユーザーがログインし、日報を作成するまでの一連の流れ                                                                                                                                                                       |
| 前提条件       | テストユーザーが存在                                                                                                                                                                                                       |
| テスト手順     | 1. ログイン画面を開く<br>2. メールアドレス・パスワードを入力<br>3. ログインボタンをクリック<br>4. ダッシュボードに遷移することを確認<br>5. 「今日の日報を作成する」ボタンをクリック<br>6. 日報作成画面に遷移することを確認 |
| 期待結果       | スムーズに画面遷移し、エラーが発生しない                                                                                                                                                                                   |

#### E2E-LOGIN-002: ログイン失敗

| 項目           | 内容                                                                                                                             |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 不正な認証情報でログイン試行                                                                                                     |
| テスト手順     | 1. ログイン画面を開く<br>2. 間違ったパスワードを入力<br>3. ログインボタンをクリック<br>4. エラーメッセージが表示されることを確認 |
| 期待結果       | 「メールアドレスまたはパスワードが正しくありません」と表示される                                                                 |

---

### 2. 日報作成フロー

#### E2E-REPORT-001: 日報作成（下書き保存）

| 項目           | 内容                                                                                                                                                                                                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 日報を下書きとして保存                                                                                                                                                                                                                                                  |
| 前提条件       | ログイン済み                                                                                                                                                                                                                                                            |
| テスト手順     | 1. ダッシュボードから「今日の日報を作成する」<br>2. 訪問記録を1件追加<br>3. 顧客を選択<br>4. 訪問内容を入力<br>5. Problemを入力<br>6. Planを入力<br>7. 「下書き保存」ボタンをクリック<br>8. ダッシュボードに戻る<br>9. 「今日の日報: 【下書き】」と表示されることを確認 |
| 期待結果       | 下書きとして保存され、再編集可能                                                                                                                                                                                                                                        |

#### E2E-REPORT-002: 日報作成（提出）

| 項目           | 内容                                                                                                                                                                             |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 日報を提出                                                                                                                                                                       |
| 前提条件       | ログイン済み                                                                                                                                                                     |
| テスト手順     | 1. 日報作成画面で必要項目を入力<br>2. 訪問記録を1件以上追加<br>3. 「提出する」ボタンをクリック<br>4. ダッシュボードに戻る<br>5. 日報一覧で「提出済み」ステータスになることを確認 |
| 期待結果       | 提出済みになり、編集不可になる                                                                                                                                                   |

#### E2E-REPORT-003: 日報作成（バリデーションエラー）

| 項目           | 内容                                                                                                      |
| -------------- | --------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 訪問記録なしで提出試行                                                                                    |
| 前提条件       | ログイン済み                                                                                              |
| テスト手順     | 1. 日報作成画面を開く<br>2. 訪問記録を追加せずに「提出する」<br>3. エラーメッセージが表示されることを確認 |
| 期待結果       | 「訪問記録が1件も登録されていません」エラーが表示される                                                   |

---

### 3. 訪問記録管理フロー

#### E2E-VISIT-001: 訪問記録の追加・編集・削除

| 項目           | 内容                                                                                                                                                                                                                                                                                        |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 訪問記録の操作                                                                                                                                                                                                                                                                              |
| 前提条件       | ログイン済み、日報作成画面を開いている                                                                                                                                                                                                                                                      |
| テスト手順     | 1. 「訪問記録を追加」ボタンをクリック<br>2. 訪問記録の入力欄が追加されることを確認<br>3. 顧客を選択<br>4. 訪問時刻、内容を入力<br>5. さらに「訪問記録を追加」で2件目を追加<br>6. 1件目の「削除」ボタンをクリック<br>7. 1件目が削除されることを確認<br>8. 下書き保存して保存されることを確認 |
| 期待結果       | 訪問記録の追加・削除が正常に動作                                                                                                                                                                                                                                                            |

---

### 4. コメント機能フロー（上長）

#### E2E-COMMENT-001: 日報へのコメント投稿

| 項目           | 内容                                                                                                                                                                                                                                        |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 上長が部下の日報にコメント                                                                                                                                                                                                                  |
| 前提条件       | 上長としてログイン済み、部下の提出済み日報が存在                                                                                                                                                                                            |
| テスト手順     | 1. 日報一覧から部下の日報を開く<br>2. Problemセクションのコメント入力欄にテキストを入力<br>3. 「投稿」ボタンをクリック<br>4. コメントが表示されることを確認<br>5. Planセクションにもコメント投稿<br>6. 両方のコメントが表示されることを確認 |
| 期待結果       | コメントが正常に投稿され、表示される                                                                                                                                                                                                        |

#### E2E-COMMENT-002: 日報承認

| 項目           | 内容                                                                                                                                                     |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 上長が日報を承認                                                                                                                                         |
| 前提条件       | 上長としてログイン済み、部下の提出済み日報が存在                                                                                                         |
| テスト手順     | 1. 日報詳細画面を開く<br>2. 「承認する」ボタンをクリック<br>3. ステータスが「承認済み」になることを確認<br>4. 「承認する」ボタンが非表示になることを確認 |
| 期待結果       | 日報が承認され、ステータスが変更される                                                                                                                   |

---

### 5. 顧客マスタ管理フロー

#### E2E-CUSTOMER-001: 顧客の登録・編集・削除

| 項目           | 内容                                                                                                                                                                                                                                                                                                                                            |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 顧客マスタの基本操作                                                                                                                                                                                                                                                                                                                            |
| 前提条件       | ログイン済み                                                                                                                                                                                                                                                                                                                                    |
| テスト手順     | 1. 顧客マスタ一覧画面を開く<br>2. 「新規登録」ボタンをクリック<br>3. 顧客情報を入力<br>4. 「登録」ボタンをクリック<br>5. 一覧に追加されたことを確認<br>6. 「詳細」ボタンから編集画面を開く<br>7. 情報を編集して「更新」<br>8. 更新されたことを確認<br>9. 「削除」ボタンをクリック<br>10. 確認ダイアログで「OK」<br>11. 一覧から消えることを確認 |
| 期待結果       | すべての操作が正常に動作                                                                                                                                                                                                                                                                                                                        |

#### E2E-CUSTOMER-002: 顧客検索

| 項目           | 内容                                                                                                                                                                                                                                                                                                                     |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| テストシナリオ | 顧客の検索・絞り込み                                                                                                                                                                                                                                                                                                     |
| 前提条件       | ログイン済み、複数の顧客が存在                                                                                                                                                                                                                                                                                           |
| テスト手順     | 1. 顧客マスタ一覧画面を開く<br>2. 顧客名に「山田」と入力<br>3. 「検索」ボタンをクリック<br>4. 「山田」を含む顧客のみ表示されることを確認<br>5. 業種プルダウンで「IT」を選択<br>6. 「検索」ボタンをクリック<br>7. IT業種で山田を含む顧客のみ表示されることを確認<br>8. 「クリア」ボタンで検索条件がクリアされることを確認 |
| 期待結果       | 検索・絞り込みが正常に動作                                                                                                                                                                                                                                                                                               |

---

### 6. 営業マスタ管理フロー（上長のみ）

#### E2E-SALES-001: 営業担当者の登録

| 項目           | 内容                                                                                                                                                                                                |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 新規営業担当者の登録                                                                                                                                                                                |
| 前提条件       | 上長としてログイン済み                                                                                                                                                                              |
| テスト手順     | 1. 営業マスタ一覧画面を開く<br>2. 「新規登録」ボタンをクリック<br>3. 営業情報を入力（名前、メール、パスワード、部署、上長、入社日）<br>4. 「登録」ボタンをクリック<br>5. 一覧に追加されたことを確認 |
| 期待結果       | 営業担当者が正常に登録される                                                                                                                                                                        |

#### E2E-SALES-002: 営業マスタアクセス権限

| 項目           | 内容                                                                                                                                                              |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | 営業担当者は営業マスタにアクセスできないことを確認                                                                                                                |
| 前提条件       | 営業としてログイン済み                                                                                                                                            |
| テスト手順     | 1. ナビゲーションメニューに「営業」が表示されないことを確認<br>2. URLを直接入力して /sales にアクセス<br>3. 403エラーまたはアクセス拒否画面が表示されることを確認 |
| 期待結果       | 権限のないユーザーはアクセスできない                                                                                                                              |

---

### 7. レスポンシブ対応テスト

#### E2E-RESPONSIVE-001: スマートフォン表示

| 項目           | 内容                                                                                                                                                                                                                               |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| テストシナリオ | モバイル端末での動作確認                                                                                                                                                                                                           |
| 前提条件       | なし                                                                                                                                                                                                                               |
| テスト手順     | 1. ブラウザをモバイルサイズに変更（375x667）<br>2. ログインから日報作成まで実施<br>3. すべての要素が適切に表示されることを確認<br>4. ボタンがタップしやすいサイズであることを確認<br>5. テーブルが横スクロール可能であることを確認 |
| 期待結果       | モバイルでも問題なく操作可能                                                                                                                                                                                                       |

---

## 非機能テスト

### 1. パフォーマンステスト

#### NFT-PERF-001: レスポンスタイム

| 項目       | 内容                                                                                |
| ---------- | ----------------------------------------------------------------------------------- |
| テスト項目 | APIレスポンスタイムの測定                                                           |
| 目的       | 各APIが許容範囲内のレスポンスタイムで応答することを確認                             |
| 測定対象   | 主要APIエンドポイント（GET /reports, POST /reports, など）                          |
| 合格基準   | - 一覧取得API: 500ms以内<br>- 詳細取得API: 300ms以内<br>- 作成・更新API: 1000ms以内 |

#### NFT-PERF-002: 同時アクセス負荷

| 項目       | 内容                                                    |
| ---------- | ------------------------------------------------------- |
| テスト項目 | 同時アクセス時のシステム挙動                            |
| 目的       | 複数ユーザーの同時アクセスに耐えられることを確認        |
| テスト条件 | 100ユーザーの同時アクセス                               |
| 合格基準   | - エラー率5%以下<br>- レスポンスタイムが通常時の2倍以内 |

#### NFT-PERF-003: データ量負荷

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| テスト項目 | 大量データ存在時のパフォーマンス                         |
| 目的       | データ量が増加してもパフォーマンスが維持されることを確認 |
| テスト条件 | - 1万件の日報<br>- 5万件の訪問記録<br>- 1000件の顧客     |
| 合格基準   | レスポンスタイムが通常時と変わらない                     |

---

### 2. セキュリティテスト

#### NFT-SEC-001: SQLインジェクション

| 項目       | 内容                                                                                   |
| ---------- | -------------------------------------------------------------------------------------- |
| テスト項目 | SQLインジェクション耐性                                                                |
| 目的       | SQLインジェクション攻撃を防げることを確認                                              |
| テスト方法 | - 検索フィールドに `' OR '1'='1` などを入力<br>- 自動スキャンツール（OWASP ZAP）を使用 |
| 合格基準   | すべての入力でSQLインジェクションが発生しない                                          |

#### NFT-SEC-002: XSS（クロスサイトスクリプティング）

| 項目       | 内容                                                                                                |
| ---------- | --------------------------------------------------------------------------------------------------- |
| テスト項目 | XSS耐性                                                                                             |
| 目的       | XSS攻撃を防げることを確認                                                                           |
| テスト方法 | - 入力フィールドに `<script>alert('XSS')</script>` を入力<br>- サニタイジング・エスケープ処理の確認 |
| 合格基準   | スクリプトが実行されず、テキストとして表示される                                                    |

#### NFT-SEC-003: 認証・認可のバイパス

| 項目       | 内容                                                                                                            |
| ---------- | --------------------------------------------------------------------------------------------------------------- |
| テスト項目 | 認証・認可の回避可能性チェック                                                                                  |
| 目的       | 不正アクセスを防げることを確認                                                                                  |
| テスト方法 | - トークンなしでAPIアクセス<br>- 他人のリソースIDを指定してアクセス<br>- 営業が上長専用エンドポイントにアクセス |
| 合格基準   | すべて適切にエラーが返される（401/403）                                                                         |

#### NFT-SEC-004: パスワード強度

| 項目       | 内容                                                           |
| ---------- | -------------------------------------------------------------- |
| テスト項目 | パスワードの保存方法                                           |
| 目的       | パスワードが平文保存されていないことを確認                     |
| テスト方法 | - DBを直接確認<br>- パスワードがハッシュ化されていることを確認 |
| 合格基準   | bcryptなどでハッシュ化されている                               |

---

### 3. ユーザビリティテスト

#### NFT-USABILITY-001: 画面遷移の直感性

| 項目       | 内容                                                          |
| ---------- | ------------------------------------------------------------- |
| テスト項目 | ユーザーが迷わず操作できるか                                  |
| 目的       | 直感的なUI/UXであることを確認                                 |
| テスト方法 | 5名のテストユーザーに実際に操作してもらい、フィードバック収集 |
| 合格基準   | 80%以上のユーザーが「迷わず操作できた」と回答                 |

#### NFT-USABILITY-002: エラーメッセージの明確性

| 項目       | 内容                                         |
| ---------- | -------------------------------------------- |
| テスト項目 | エラーメッセージがわかりやすいか             |
| 目的       | ユーザーが問題を理解し、対処できることを確認 |
| テスト方法 | 意図的にエラーを発生させ、メッセージを確認   |
| 合格基準   | 何が問題で、どう対処すべきかが明確           |

---

### 4. 互換性テスト

#### NFT-COMPAT-001: ブラウザ互換性

| 項目         | 内容                                                                                |
| ------------ | ----------------------------------------------------------------------------------- |
| テスト項目   | 複数ブラウザでの動作確認                                                            |
| 対象ブラウザ | - Chrome（最新版）<br>- Firefox（最新版）<br>- Safari（最新版）<br>- Edge（最新版） |
| 合格基準     | すべてのブラウザで正常動作                                                          |

#### NFT-COMPAT-002: デバイス互換性

| 項目         | 内容                                                                                |
| ------------ | ----------------------------------------------------------------------------------- |
| テスト項目   | 複数デバイスでの動作確認                                                            |
| 対象デバイス | - PC（Windows, Mac）<br>- タブレット（iPad）<br>- スマートフォン（iPhone, Android） |
| 合格基準     | すべてのデバイスで正常動作、表示崩れなし                                            |

---

## テストデータ

### マスタデータ（シードデータ）

#### 営業担当者

```json
[
  {
    "sales_id": 1,
    "sales_name": "山田太郎",
    "email": "yamada@example.com",
    "password": "password123",
    "department": "営業1部",
    "manager_id": 5,
    "is_manager": false
  },
  {
    "sales_id": 2,
    "sales_name": "鈴木一郎",
    "email": "suzuki@example.com",
    "password": "password123",
    "department": "営業1部",
    "manager_id": 5,
    "is_manager": false
  },
  {
    "sales_id": 5,
    "sales_name": "佐藤部長",
    "email": "sato@example.com",
    "password": "password123",
    "department": "営業1部",
    "manager_id": null,
    "is_manager": true
  }
]
```

#### 顧客

```json
[
  {
    "customer_id": 10,
    "customer_name": "山田一郎",
    "company_name": "株式会社ABC",
    "industry": "IT",
    "sales_id": 1
  },
  {
    "customer_id": 11,
    "customer_name": "佐藤花子",
    "company_name": "株式会社DEF",
    "industry": "製造",
    "sales_id": 1
  },
  {
    "customer_id": 12,
    "customer_name": "田中次郎",
    "company_name": "株式会社GHI",
    "industry": "小売",
    "sales_id": 2
  }
]
```

### トランザクションデータ（テスト実行時に作成）

#### 日報

- 下書き、提出済み、承認済みの各ステータスの日報を用意
- 訪問記録あり/なしのパターンを用意
- コメントあり/なしのパターンを用意

---

## テスト実行スケジュール

| フェーズ     | 期間             | 担当         | 備考             |
| ------------ | ---------------- | ------------ | ---------------- |
| 単体テスト   | 開発中（継続）   | 開発者       | コミット前に実行 |
| 結合テスト   | 機能実装完了後   | QAチーム     | CIで自動実行     |
| E2Eテスト    | 全機能実装完了後 | QAチーム     | 週次で実行       |
| 非機能テスト | リリース2週間前  | QAチーム     | 本番環境想定     |
| 受入テスト   | リリース1週間前  | ユーザー代表 | ステージング環境 |

---

## 不具合管理

### 不具合の重要度（Severity）

| レベル   | 定義               | 例                               |
| -------- | ------------------ | -------------------------------- |
| Critical | システムが使用不可 | ログインできない、システムダウン |
| High     | 主要機能が使用不可 | 日報が提出できない、承認できない |
| Medium   | 一部機能に問題     | 検索が動作しない、表示崩れ       |
| Low      | 軽微な問題         | 文言の誤字、マイナーなUI問題     |

### 不具合の対応方針

| 重要度   | 対応方針                                   |
| -------- | ------------------------------------------ |
| Critical | 即座に修正、リリース延期                   |
| High     | 優先的に修正、リリース前に解決必須         |
| Medium   | リリース前に修正、または次回リリースで対応 |
| Low      | 余裕があれば対応、バックログに追加         |

---

## 補足事項

### 自動テストの実行

- CI/CDパイプラインに組み込み、プルリクエスト時に自動実行
- テスト失敗時はマージをブロック
- カバレッジレポートを自動生成

### テストコードの品質

- 意味のあるアサーションを記述（`expect(true).toBe(true)` 禁止）
- テストケース名は何をテストしているか明確に記述
- モックは必要最小限に留める
- テストデータはハードコーディングせず、ファクトリー関数を使用

### 継続的改善

- 不具合が発見されたら、同じ問題を検知するテストケースを追加
- テストが失敗しやすい（flaky）場合は原因を調査し、安定化
- カバレッジが低い箇所を定期的に確認し、テストを追加
